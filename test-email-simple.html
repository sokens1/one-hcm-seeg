<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Email Supabase</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: 50px auto; padding: 20px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, button { width: 100%; padding: 10px; margin-bottom: 10px; }
        button { background: #007bff; color: white; border: none; cursor: pointer; }
        button:hover { background: #0056b3; }
        .result { margin-top: 20px; padding: 15px; border-radius: 5px; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .loading { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
    </style>
</head>
<body>
    <h1>üß™ Test Email Supabase - Diagnostic</h1>
    
    <div class="form-group">
        <label for="supabaseUrl">URL Supabase:</label>
        <input type="text" id="supabaseUrl" value="https://fyiitzndlqcnyluwkpqp.supabase.co" readonly>
    </div>
    
    <div class="form-group">
        <label for="supabaseKey">Cl√© Anon Supabase:</label>
        <input type="text" id="supabaseKey" placeholder="Votre cl√© anon..." />
    </div>
    
    <div class="form-group">
        <label for="testEmail">Email de test:</label>
        <input type="email" id="testEmail" value="test@example.com" />
    </div>
    
    <div class="form-group">
        <label for="firstName">Pr√©nom:</label>
        <input type="text" id="firstName" value="Test" />
    </div>
    
    <div class="form-group">
        <label for="jobTitle">Titre du poste:</label>
        <input type="text" id="jobTitle" value="D√©veloppeur Test" />
    </div>
    
    <button onclick="testEmail()">üß™ Tester l'Email</button>
    <button onclick="testConnection()">üîó Tester la Connexion</button>
    
    <div id="result"></div>
    
    <script>
        let supabase;
        
        function initSupabase() {
            const url = document.getElementById('supabaseUrl').value;
            const key = document.getElementById('supabaseKey').value;
            
            if (!key) {
                showResult('‚ùå Veuillez saisir votre cl√© anon Supabase', 'error');
                return false;
            }
            
            try {
                supabase = window.supabase.createClient(url, key);
                return true;
            } catch (error) {
                showResult('‚ùå Erreur de cr√©ation du client Supabase: ' + error.message, 'error');
                return false;
            }
        }
        
        async function testConnection() {
            if (!initSupabase()) return;
            
            showResult('üîÑ Test de connexion en cours...', 'loading');
            
            try {
                const { data, error } = await supabase.from('users').select('count').limit(1);
                
                if (error) {
                    showResult('‚ùå Erreur de connexion: ' + error.message, 'error');
                } else {
                    showResult('‚úÖ Connexion Supabase r√©ussie !', 'success');
                }
            } catch (error) {
                showResult('‚ùå Erreur inattendue: ' + error.message, 'error');
            }
        }
        
        async function testEmail() {
            if (!initSupabase()) return;
            
            const testEmail = document.getElementById('testEmail').value;
            const firstName = document.getElementById('firstName').value;
            const jobTitle = document.getElementById('jobTitle').value;
            
            if (!testEmail || !firstName || !jobTitle) {
                showResult('‚ùå Veuillez remplir tous les champs', 'error');
                return;
            }
            
            showResult('üîÑ Envoi de l\'email de test...', 'loading');
            
            try {
                const payload = {
                    to: testEmail,
                    firstName: firstName,
                    jobTitle: jobTitle,
                    applicationId: 'TEST-' + Date.now()
                };
                
                console.log('Payload envoy√©:', payload);
                
                const { data, error } = await supabase.functions.invoke('send_application_confirmation', {
                    body: payload
                });
                
                console.log('R√©ponse compl√®te:', { data, error });
                
                if (error) {
                    showResult('‚ùå Erreur lors de l\'envoi: ' + JSON.stringify(error, null, 2), 'error');
                } else {
                    showResult('‚úÖ Email envoy√© avec succ√®s ! R√©ponse: ' + JSON.stringify(data, null, 2), 'success');
                }
            } catch (error) {
                console.error('Erreur compl√®te:', error);
                showResult('‚ùå Erreur inattendue: ' + error.message + '\n\nD√©tails: ' + JSON.stringify(error, null, 2), 'error');
            }
        }
        
        function showResult(message, type) {
            const resultDiv = document.getElementById('result');
            resultDiv.className = 'result ' + type;
            resultDiv.innerHTML = message.replace(/\n/g, '<br>');
        }
        
        // Instructions
        showResult(`
            <h3>üìã Instructions de Test</h3>
            <p><strong>1.</strong> Saisissez votre cl√© anon Supabase (trouvable dans votre dashboard Supabase)</p>
            <p><strong>2.</strong> Cliquez sur "Tester la Connexion" pour v√©rifier l'acc√®s</p>
            <p><strong>3.</strong> Cliquez sur "Tester l'Email" pour envoyer un email de test</p>
            <p><strong>4.</strong> V√©rifiez la console du navigateur pour plus de d√©tails</p>
        `, 'loading');
    </script>
</body>
</html>
