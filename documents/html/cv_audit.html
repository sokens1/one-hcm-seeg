<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Audit des CV — Informations manquantes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", sans-serif; }
        .tab-active { @apply bg-blue-600 text-white; }
        .tab-inactive { @apply bg-white text-blue-600 hover:bg-blue-50; }
        .badge { @apply inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium; }
    </style>
</head>
<body class="bg-gray-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <header class="mb-8">
            <h1 class="text-2xl sm:text-3xl font-bold text-gray-900">Audit des CV — Contrôle des informations</h1>
            <p class="mt-2 text-gray-600">Chargement des données depuis <code>documents/json_extraction/cv_extraction.json</code> et séparation en deux listes : candidats avec informations complètes et candidats avec identifiants manquants.</p>
        </header>

        <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 mb-8">
            <div class="rounded-xl border bg-white p-4 shadow-sm">
                <div class="text-gray-500 text-sm">Total enregistrements</div>
                <div id="statTotal" class="mt-1 text-2xl font-semibold text-gray-900">-</div>
            </div>
            <div class="rounded-xl border bg-white p-4 shadow-sm">
                <div class="text-gray-500 text-sm">Complets (avec candidate_id et job_offer_id)</div>
                <div id="statComplets" class="mt-1 text-2xl font-semibold text-emerald-700">-</div>
            </div>
            <div class="rounded-xl border bg-white p-4 shadow-sm">
                <div class="text-gray-500 text-sm">Incomplets (au moins un identifiant manquant)</div>
                <div id="statIncomplets" class="mt-1 text-2xl font-semibold text-rose-700">-</div>
            </div>
            <div class="rounded-xl border bg-white p-4 shadow-sm">
                <div class="text-gray-500 text-sm">Dernière mise à jour</div>
                <div id="statUpdated" class="mt-1 text-2xl font-semibold text-gray-900">-</div>
            </div>
            <div class="rounded-xl border bg-white p-4 shadow-sm">
                <div class="flex items-center justify-between">
                    <div class="text-gray-500 text-sm">CV courts (contenu insuffisant)</div>
                    <span class="text-[11px] text-gray-400">seuil</span>
                </div>
                <div class="mt-1 flex items-center gap-2">
                    <div id="statCvCourts" class="text-2xl font-semibold text-amber-700">-</div>
                    <input id="minLengthInput" type="number" min="20" max="2000" step="10" class="ml-auto w-24 rounded-md border-gray-300 text-sm shadow-sm focus:border-blue-500 focus:ring-blue-500" />
                </div>
            </div>
        </section>

        <div class="mb-6 flex items-center justify-between gap-3">
            <div class="flex flex-wrap gap-2">
                <button id="btnComplets" class="tab-active rounded-lg px-4 py-2 text-sm font-medium">Candidats complets</button>
                <button id="btnIncomplets" class="tab-inactive rounded-lg px-4 py-2 text-sm font-medium">Candidats incomplets</button>
                <button id="btnCvCourts" class="tab-inactive rounded-lg px-4 py-2 text-sm font-medium">CV courts</button>
            </div>
            <div class="flex items-center gap-2">
                <input id="searchInput" type="text" placeholder="Rechercher par nom, poste, texte…" class="w-64 rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" />
                <button id="btnReset" class="rounded-lg border px-3 py-2 text-sm text-gray-700 hover:bg-gray-100">Réinitialiser</button>
            </div>
        </div>

        <div id="panelComplets" class="rounded-xl border bg-white p-4 shadow-sm">
            <div class="mb-3 flex items-center justify-between">
                <h2 class="text-lg font-semibold text-gray-900">Candidats avec toutes les informations</h2>
                <span id="badgeComplets" class="badge bg-emerald-50 text-emerald-700 ring-1 ring-inset ring-emerald-600/20">-</span>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="whitespace-nowrap px-4 py-2 text-left text-xs font-medium uppercase tracking-wider text-gray-500">Candidat</th>
                            <th class="whitespace-nowrap px-4 py-2 text-left text-xs font-medium uppercase tracking-wider text-gray-500">Poste</th>
                            <th class="px-4 py-2 text-left text-xs font-medium uppercase tracking-wider text-gray-500">Extrait du CV</th>
                            <th class="whitespace-nowrap px-4 py-2 text-left text-xs font-medium uppercase tracking-wider text-gray-500">job_offer_id</th>
                            <th class="whitespace-nowrap px-4 py-2 text-left text-xs font-medium uppercase tracking-wider text-gray-500">candidate_id</th>
                        </tr>
                    </thead>
                    <tbody id="tbodyComplets" class="divide-y divide-gray-100 bg-white"></tbody>
                </table>
            </div>
        </div>

        <div id="panelIncomplets" class="mt-6 rounded-xl border bg-white p-4 shadow-sm hidden">
            <div class="mb-3 flex items-center justify-between">
                <h2 class="text-lg font-semibold text-gray-900">Candidats avec informations manquantes</h2>
                <span id="badgeIncomplets" class="badge bg-rose-50 text-rose-700 ring-1 ring-inset ring-rose-600/20">-</span>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="whitespace-nowrap px-4 py-2 text-left text-xs font-medium uppercase tracking-wider text-gray-500">Candidat</th>
                            <th class="whitespace-nowrap px-4 py-2 text-left text-xs font-medium uppercase tracking-wider text-gray-500">Poste</th>
                            <th class="px-4 py-2 text-left text-xs font-medium uppercase tracking-wider text-gray-500">Extrait du CV</th>
                            <th class="whitespace-nowrap px-4 py-2 text-left text-xs font-medium uppercase tracking-wider text-gray-500">job_offer_id</th>
                            <th class="whitespace-nowrap px-4 py-2 text-left text-xs font-medium uppercase tracking-wider text-gray-500">candidate_id</th>
                        </tr>
                    </thead>
                    <tbody id="tbodyIncomplets" class="divide-y divide-gray-100 bg-white"></tbody>
                </table>
            </div>
        </div>

        <div id="panelCvCourts" class="mt-6 rounded-xl border bg-white p-4 shadow-sm hidden">
            <div class="mb-3 flex items-center justify-between">
                <h2 class="text-lg font-semibold text-gray-900">Candidats avec CV trop court</h2>
                <span id="badgeCvCourts" class="badge bg-amber-50 text-amber-700 ring-1 ring-inset ring-amber-600/20">-</span>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="whitespace-nowrap px-4 py-2 text-left text-xs font-medium uppercase tracking-wider text-gray-500">Candidat</th>
                            <th class="whitespace-nowrap px-4 py-2 text-left text-xs font-medium uppercase tracking-wider text-gray-500">Poste</th>
                            <th class="px-4 py-2 text-left text-xs font-medium uppercase tracking-wider text-gray-500">Extrait du CV</th>
                            <th class="whitespace-nowrap px-4 py-2 text-left text-xs font-medium uppercase tracking-wider text-gray-500">job_offer_id</th>
                            <th class="whitespace-nowrap px-4 py-2 text-left text-xs font-medium uppercase tracking-wider text-gray-500">candidate_id</th>
                        </tr>
                    </thead>
                    <tbody id="tbodyCvCourts" class="divide-y divide-gray-100 bg-white"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const state = {
            data: [],
            filteredComplets: [],
            filteredIncomplets: [],
            filteredCvCourts: [],
            activeTab: 'complets',
            minLength: 200,
        };

        function safeText(value) {
            if (value === undefined || value === null) return '-';
            const str = String(value).trim();
            return str === '' ? '-' : str;
        }

        function truncate(text, max = 160) {
            const t = safeText(text);
            if (t === '-' || t.length <= max) return t;
            return t.slice(0, max) + '…';
        }

        function matchesQuery(row, q) {
            if (!q) return true;
            const target = [row.candidate_name, row.job_title, row.cv_text].map(v => (v || '').toLowerCase()).join(' \n ');
            return target.includes(q);
        }

        function splitData() {
            const isFilled = v => v !== undefined && v !== null && String(v).trim() !== '';
            const complets = [];
            const incomplets = [];
            const cvCourts = [];
            for (const r of state.data) {
                const ok = isFilled(r.candidate_id) && isFilled(r.job_offer_id);
                (ok ? complets : incomplets).push(r);
                const cv = (r.cv_text ?? '').toString();
                if (cv.trim().length < state.minLength) cvCourts.push(r);
            }
            state.filteredComplets = complets;
            state.filteredIncomplets = incomplets;
            state.filteredCvCourts = cvCourts;
        }

        function renderStats() {
            document.getElementById('statTotal').textContent = state.data.length;
            document.getElementById('statComplets').textContent = state.filteredComplets.length;
            document.getElementById('statIncomplets').textContent = state.filteredIncomplets.length;
            const now = new Date();
            document.getElementById('statUpdated').textContent = now.toLocaleString();
            document.getElementById('badgeComplets').textContent = state.filteredComplets.length + ' éléments';
            document.getElementById('badgeIncomplets').textContent = state.filteredIncomplets.length + ' éléments';
            document.getElementById('statCvCourts').textContent = state.filteredCvCourts.length;
            document.getElementById('badgeCvCourts').textContent = state.filteredCvCourts.length + ' éléments';
            document.getElementById('minLengthInput').value = state.minLength;
        }

        function buildRow(r) {
            return `
                <tr>
                    <td class="px-4 py-2 align-top text-sm text-gray-900">${safeText(r.candidate_name)}</td>
                    <td class="px-4 py-2 align-top text-sm text-gray-700">${safeText(r.job_title)}</td>
                    <td class="px-4 py-2 align-top text-sm text-gray-600">${truncate(r.cv_text)}</td>
                    <td class="px-4 py-2 align-top text-xs text-gray-500">${safeText(r.job_offer_id)}</td>
                    <td class="px-4 py-2 align-top text-xs text-gray-500">${safeText(r.candidate_id)}</td>
                </tr>
            `;
        }

        function renderTables() {
            const q = document.getElementById('searchInput').value.trim().toLowerCase();
            const filteredComplets = state.filteredComplets.filter(r => matchesQuery(r, q));
            const filteredIncomplets = state.filteredIncomplets.filter(r => matchesQuery(r, q));
            const filteredCvCourts = state.filteredCvCourts.filter(r => matchesQuery(r, q));

            const tbodyComplets = document.getElementById('tbodyComplets');
            const tbodyIncomplets = document.getElementById('tbodyIncomplets');
            const tbodyCvCourts = document.getElementById('tbodyCvCourts');

            tbodyComplets.innerHTML = filteredComplets.map(buildRow).join('');
            tbodyIncomplets.innerHTML = filteredIncomplets.map(buildRow).join('');
            tbodyCvCourts.innerHTML = filteredCvCourts.map(buildRow).join('');

            document.getElementById('badgeComplets').textContent = filteredComplets.length + ' éléments';
            document.getElementById('badgeIncomplets').textContent = filteredIncomplets.length + ' éléments';
            document.getElementById('badgeCvCourts').textContent = filteredCvCourts.length + ' éléments';
        }

        function switchTab(tab) {
            state.activeTab = tab;
            const btnComplets = document.getElementById('btnComplets');
            const btnIncomplets = document.getElementById('btnIncomplets');
            const btnCvCourts = document.getElementById('btnCvCourts');
            const panelComplets = document.getElementById('panelComplets');
            const panelIncomplets = document.getElementById('panelIncomplets');
            const panelCvCourts = document.getElementById('panelCvCourts');

            if (tab === 'complets') {
                btnComplets.classList.add('tab-active');
                btnComplets.classList.remove('tab-inactive');
                btnIncomplets.classList.add('tab-inactive');
                btnIncomplets.classList.remove('tab-active');
                btnCvCourts.classList.add('tab-inactive');
                btnCvCourts.classList.remove('tab-active');
                panelComplets.classList.remove('hidden');
                panelIncomplets.classList.add('hidden');
                panelCvCourts.classList.add('hidden');
            } else {
                btnComplets.classList.add('tab-inactive');
                btnComplets.classList.remove('tab-active');
                if (tab === 'incomplets') {
                    btnIncomplets.classList.add('tab-active');
                    btnIncomplets.classList.remove('tab-inactive');
                    btnCvCourts.classList.add('tab-inactive');
                    btnCvCourts.classList.remove('tab-active');
                    panelIncomplets.classList.remove('hidden');
                    panelComplets.classList.add('hidden');
                    panelCvCourts.classList.add('hidden');
                } else {
                    btnCvCourts.classList.add('tab-active');
                    btnCvCourts.classList.remove('tab-inactive');
                    btnIncomplets.classList.add('tab-inactive');
                    btnIncomplets.classList.remove('tab-active');
                    panelCvCourts.classList.remove('hidden');
                    panelComplets.classList.add('hidden');
                    panelIncomplets.classList.add('hidden');
                }
            }
        }

        async function loadData() {
            try {
                const res = await fetch('../json_extraction/cv_extraction.json', { cache: 'no-store' });
                if (!res.ok) throw new Error('HTTP ' + res.status);
                const json = await res.json();
                // S'assurer que c'est un tableau d'objets
                state.data = Array.isArray(json) ? json : [];
                splitData();
                renderStats();
                renderTables();
            } catch (err) {
                console.error('Erreur de chargement des données:', err);
                alert('Erreur lors du chargement des données. Vérifiez que cv_extraction.json existe.');
            }
        }

        // Events
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('btnComplets').addEventListener('click', () => switchTab('complets'));
            document.getElementById('btnIncomplets').addEventListener('click', () => switchTab('incomplets'));
            document.getElementById('btnCvCourts').addEventListener('click', () => switchTab('cv_courts'));
            document.getElementById('searchInput').addEventListener('input', renderTables);
            document.getElementById('btnReset').addEventListener('click', () => {
                document.getElementById('searchInput').value = '';
                renderTables();
            });
            document.getElementById('minLengthInput').addEventListener('change', (e) => {
                const val = parseInt(e.target.value, 10);
                state.minLength = Number.isFinite(val) ? Math.max(20, Math.min(2000, val)) : 200;
                splitData();
                renderStats();
                renderTables();
            });
            loadData();
        });
    </script>
</body>
</html>